<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="LOGO-BOY-TOYS.png" type="image/png">
    <title>Validación de Cantidad</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        .separator {
            background-color: #f0f0f0;
            height: 10px;
        }
    </style>
</head>
<body>
    <h1>Validación de Cantidad</h1>
    <!-- Botón para regresar a ingreso_datos.html -->
    <a href="ingreso_datos.html">Regresar</a>
    <br><br>
    
    <!-- Botón para aplicar filtros -->
    <div>
        <label for="filterBarcode">Código de Barra:</label>
        <input type="text" id="filterBarcode" name="filterBarcode">
        
        <label for="filterRef">Ref:</label>
        <input type="text" id="filterRef" name="filterRef">

        <label for="filterBox">#Caja:</label>
        <input type="text" id="filterBox" name="filterBox">

        <label for="fecha_inicio">Fecha Inicio:</label>
        <input type="date" id="fecha_inicio" name="fecha_inicio">

        <label for="fecha_fin">Fecha Fin:</label>
        <input type="date" id="fecha_fin" name="fecha_fin">

        <button id="applyFilters">Aplicar Filtros</button>
    </div>
    <br><br>
    
    <table id="consolidatedTable">
        <thead>
            <tr>
                <th>Código de Barra</th>
                <th>Ref</th>
                <th>Descripción del Ítem</th>
                <th>Cantidad</th>
                <th>#Caja</th>
            </tr>
        </thead>
        <tbody>
            <!-- Aquí se insertarán las filas con los datos -->
        </tbody>
    </table>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            function fetchData() {
                const filterBox = document.getElementById("filterBox").value;
                const filterBarcode = document.getElementById("filterBarcode").value;
                const filterRef = document.getElementById("filterRef").value;
                const fechaInicio = document.getElementById("fecha_inicio").value;
                const fechaFin = document.getElementById("fecha_fin").value;

                // Construir la URL con los parámetros de filtro
                const queryParams = new URLSearchParams({
                    box: filterBox || '',
                    barcode: filterBarcode || '',
                    ref: filterRef || '',
                    fecha_inicio: fechaInicio || '',
                    fecha_fin: fechaFin || ''
                }).toString();

                fetch('get_consolidated_data.php?' + queryParams)
                    .then(response => response.json())
                    .then(data => {
                        renderTable(data);
                    })
                    .catch(error => console.error('Error:', error));
            }

            // Llamar a fetchData para cargar todos los datos por defecto al inicio
            fetchData();

            document.getElementById("applyFilters").addEventListener("click", fetchData);

            function renderTable(data) {
                const tableBody = document.querySelector("#consolidatedTable tbody");
                tableBody.innerHTML = "";

                let lastBox = null;
                data.forEach(item => {
                    // Check if a new separator is needed
                    if (lastBox && lastBox !== item.box) {
                        const separatorRow = document.createElement("tr");
                        const separatorCell = document.createElement("td");
                        separatorCell.colSpan = 5;
                        separatorCell.className = "separator";
                        separatorRow.appendChild(separatorCell);
                        tableBody.appendChild(separatorRow);
                    }

                    const row = document.createElement("tr");

                    const barcodeCell = document.createElement("td");
                    barcodeCell.textContent = item.barcode;
                    row.appendChild(barcodeCell);

                    const refCell = document.createElement("td");
                    refCell.textContent = item.ref;
                    row.appendChild(refCell);

                    const desItemCell = document.createElement("td");
                    desItemCell.textContent = item.des_Item;
                    row.appendChild(desItemCell);

                    const totalCell = document.createElement("td");
                    totalCell.textContent = item.total;
                    row.appendChild(totalCell);

                    const boxCell = document.createElement("td");
                    boxCell.textContent = item.box;
                    row.appendChild(boxCell);

                    tableBody.appendChild(row);

                    lastBox = item.box;
                });

                if (data.length === 0) {
                    const row = document.createElement("tr");
                    const cell = document.createElement("td");
                    cell.colSpan = 5;
                    cell.textContent = "No se encontraron datos.";
                    row.appendChild(cell);
                    tableBody.appendChild(row);
                }
            }
        });
    </script>
</body>
</html>
