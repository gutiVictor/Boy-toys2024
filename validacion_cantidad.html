<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validación de Cantidad</title>
    <style>
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        .separator {
            background-color: #f0f0f0;
            height: 10px;
        }
    </style>
</head>
<body>
    <h1>Validación de Cantidad</h1>
    
    <div>
        <label for="filterBox">Caja:</label>
        <input type="text" id="filterBox" name="filterBox">
        
        <label for="filterBarcode">Código de Barra:</label>
        <input type="text" id="filterBarcode" name="filterBarcode">
        
        <label for="filterRef">Ref:</label>
        <input type="text" id="filterRef" name="filterRef">
        
        <label for="filterDate">Fecha:</label>
        <input type="date" id="filterDate" name="filterDate">
        
        <button id="applyFilters">Aplicar Filtros</button>
    </div>
    
    <table id="consolidatedTable">
        <thead>
            <tr>
                <th>Código de Barra</th>
                <th>Ref</th>
                <th>Descripción del Ítem</th>
                <th>Total</th>
                <th>Caja</th>
            </tr>
        </thead>
        <tbody>
            <!-- Aquí se insertarán las filas con los datos -->
        </tbody>
    </table>

    <!-- Botón para regresar a ingreso_datos.html -->
    <a href="ingreso_datos.html">Regresar</a>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            let allData = [];

            fetch('get_consolidated_data.php')
                .then(response => response.json())
                .then(data => {
                    allData = data;
                    renderTable(data);
                })
                .catch(error => console.error('Error:', error));

            document.getElementById("applyFilters").addEventListener("click", function() {
                const filterBox = document.getElementById("filterBox").value.toLowerCase();
                const filterBarcode = document.getElementById("filterBarcode").value.toLowerCase();
                const filterRef = document.getElementById("filterRef").value.toLowerCase();
                const filterDate = document.getElementById("filterDate").value;

                const filteredData = allData.filter(item => {
                    return (filterBox === "" || item.box.toLowerCase().includes(filterBox)) &&
                           (filterBarcode === "" || item.barcode.toLowerCase().includes(filterBarcode)) &&
                           (filterRef === "" || item.ref.toLowerCase().includes(filterRef)) &&
                           (filterDate === "" || new Date(item.date).toISOString().split('T')[0] === filterDate);
                });

                renderTable(filteredData);
            });

            function renderTable(data) {
                const tableBody = document.querySelector("#consolidatedTable tbody");
                tableBody.innerHTML = "";

                let lastBox = null;
                data.forEach(item => {
                    // Check if a new separator is needed
                    if (lastBox && lastBox !== item.box) {
                        const separatorRow = document.createElement("tr");
                        const separatorCell = document.createElement("td");
                        separatorCell.colSpan = 5;
                        separatorCell.className = "separator";
                        separatorRow.appendChild(separatorCell);
                        tableBody.appendChild(separatorRow);
                    }

                    const row = document.createElement("tr");

                    const barcodeCell = document.createElement("td");
                    barcodeCell.textContent = item.barcode;
                    row.appendChild(barcodeCell);

                    const refCell = document.createElement("td");
                    refCell.textContent = item.ref;
                    row.appendChild(refCell);

                    const desItemCell = document.createElement("td");
                    desItemCell.textContent = item.des_Item;
                    row.appendChild(desItemCell);

                    const totalCell = document.createElement("td");
                    totalCell.textContent = item.total;
                    row.appendChild(totalCell);

                    const boxCell = document.createElement("td");
                    boxCell.textContent = item.box;
                    row.appendChild(boxCell);

                    tableBody.appendChild(row);

                    lastBox = item.box;
                });

                if (data.length === 0) {
                    const row = document.createElement("tr");
                    const cell = document.createElement("td");
                    cell.colSpan = 5;
                    cell.textContent = "No se encontraron datos.";
                    row.appendChild(cell);
                    tableBody.appendChild(row);
                }
            }
        });
    </script>
</body>
</html>
